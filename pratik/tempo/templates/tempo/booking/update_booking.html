{% include "navbar.html" %}
<div class="main-panel">
  <div class="content-wrapper">
    <div class="container-fluid px-4 py-3">
      <h4 class="text-white mb-4">üìù Update Booking</h4>

      <form method="post" action="/update_booking/{{ booking.id }}/" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="card p-4 mb-4">
          <div class="text-info fw-semibold mb-3">üìò Basic Information</div>
          <div class="row g-3">
            <div class="col-md-4">
              <label>Booking Number *</label>
              <input type="text" name="booking_number" class="form-control" value="{{ booking.booking_number }}" required>
            </div>
            <div class="col-md-4">
              <label>Booking Date *</label>
              <input type="date" name="booking_date" class="form-control" value="{{ booking.booking_date|date:'Y-m-d' }}" required>
            </div>
            <div class="col-md-4">
              <label>Our GST Number</label>
              <input type="text" name="our_gst" value="{{ booking.our_gst }}" class="form-control">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card p-4 mb-4">
              <div class="text-success fw-semibold mb-3">üë§ Party Information</div>
              <label>Party *</label>
              <select name="party_id" id="partySelect" class="form-control" onchange="fillPartyDetails()" required>
                {% for party in parties %}
                  <option value="{{ party.id }}"
                    data-address="{{ party.address }}"
                    data-contact="{{ party.contact_number }}"
                    data-gst="{{ party.gst_no }}"
                    {% if booking.party.id == party.id %}selected{% endif %}>
                    {{ party.party_name }}
                  </option>
                {% endfor %}
              </select>
              <label>Address</label>
              <input type="text" name="address" id="address" class="form-control" readonly>

              <label>Contact</label>
              <input type="text" name="contact_number" id="contact_number" class="form-control" readonly>

              <label>GST Number</label>
              <input type="text" name="gst_no" id="gst_no" class="form-control" readonly>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card p-4 mb-4">
              <div class="text-warning fw-semibold mb-3">üöö Vehicle Information</div>
              <label>Vehicle *</label>
              <select name="vehicle_id" class="form-control" id="vehicleSelect" onchange="fillVehicleDetails()" required>
                {% for vehicle in vehicles %}
                  <option
                    value="{{ vehicle.id }}"
                    data-owner="{{ vehicle.party_name }}"
                    data-contact="{{ vehicle.contact_number }}"
                    data-type="{{ vehicle.vehicle_type }}"
                    data-address="{{ vehicle.address }}"
                    data-ownership="{{ vehicle.ownership }}"
                    {% if booking.vehicle.id == vehicle.id %}selected{% endif %}>
                    {{ vehicle.vehicle_number }} ({{ vehicle.vehicle_type }})
                  </option>
                {% endfor %}
              </select>

              <label>Owner Name</label>
              <input type="text" name="owner_name" id="owner_name" class="form-control" readonly>

              <label>Contact Number</label>
              <input type="text" name="owner_contact" id="owner_contact" class="form-control" readonly>

              <label>Vehicle Type</label>
              <input type="text" name="vehicle_type" id="vehicle_type" class="form-control" readonly>

              <label>Address</label>
              <input type="text" name="owner_address" id="owner_address" class="form-control" readonly>

              <label>Ownership</label>
              <input type="text" name="ownership" id="ownership" class="form-control" readonly>
            </div>
          </div>
        </div>

        <div class="card p-4 mb-4">
          <div class="text-purple fw-semibold mb-3">üö£Ô∏è Journey Information</div>
          <div class="row g-3">
            <div class="col-md-6">
              <label>From City *</label>
              <select name="from_city" class="form-select" required>
                {% for city in cities %}
                  <option value="{{ city.id }}" {% if booking.from_city.id == city.id %}selected{% endif %}>{{ city.city }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label>To City *</label>
              <select name="to_city" class="form-select" required>
                {% for city in cities %}
                  <option value="{{ city.id }}" {% if booking.to_city.id == city.id %}selected{% endif %}>{{ city.city }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card p-4 mb-4">
              <div class="text-warning fw-semibold mb-3">üíµ Charges & Deductions</div>
              <label>Total Hire *</label>
              <input type="number" name="total_hire" class="form-control" value="{{ booking.total_hire }}" required oninput="calculateFinalAmounts()">
              <label>Advance</label>
              <input type="number" name="advance" class="form-control" value="{{ booking.advance }}" oninput="calculateFinalAmounts()">
              <label>Hamali</label>
              <input type="number" name="hamali" class="form-control" value="{{ booking.hamali }}" oninput="calculateFinalAmounts()">
              <label>TDS</label>
              <input type="number" name="tds" class="form-control" value="{{ booking.tds }}" oninput="calculateFinalAmounts()">
              <label>ST Charges</label>
              <input type="number" name="st_charges" class="form-control" value="{{ booking.st_charges }}" oninput="calculateFinalAmounts()">
              <label>Commission</label>
              <input type="number" name="commission" class="form-control" value="{{ booking.commission }}" oninput="calculateFinalAmounts()">
              <label>Other Charges/Deductions</label>
              <input type="number" name="other_charges" class="form-control" value="{{ booking.other_charges }}" oninput="calculateFinalAmounts()">
            </div>
          </div>

          <div class="col-md-6">
            <div class="card p-4 mb-4">
              <div class="text-success fw-semibold mb-3">üìä Final Calculation</div>
              <label>Balance</label>
              <input type="number" name="balance" id="balance" class="form-control" value="{{ booking.balance }}" readonly>

              <label>My Expenses</label>
              <input type="number" name="myExpense" id="myExpense" class="form-control" value="{{ booking.myExpense }}" readonly>

              <label>Profit</label>
              <input type="number" name="profit" id="profit" class="form-control" value="{{ booking.profit }}" readonly>

              <label class="mt-2">Remark</label>
              <textarea name="remark" class="form-control">{{ booking.remark }}</textarea>
            </div>
          </div>
        </div>

        <div class="text-end">
          <button type="submit" class="btn btn-primary px-4">Save Booking</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function fillVehicleDetails() {
  const vehicleSelect = document.getElementById('vehicleSelect');
  const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
  document.getElementById('owner_name').value = selectedOption.getAttribute('data-owner') || '';
  document.getElementById('owner_contact').value = selectedOption.getAttribute('data-contact') || '';
  document.getElementById('vehicle_type').value = selectedOption.getAttribute('data-type') || '';
  document.getElementById('owner_address').value = selectedOption.getAttribute('data-address') || '';
  document.getElementById('ownership').value = selectedOption.getAttribute('data-ownership') || '';
}

function fillPartyDetails() {
  const partySelect = document.getElementById('partySelect');
  const selectedOption = partySelect.options[partySelect.selectedIndex];
  document.getElementById('address').value = selectedOption.getAttribute('data-address') || '';
  document.getElementById('contact_number').value = selectedOption.getAttribute('data-contact') || '';
  document.getElementById('gst_no').value = selectedOption.getAttribute('data-gst') || '';
}

function calculateFinalAmounts() {
  const getValue = name => parseFloat(document.querySelector(`[name="${name}"]`).value) || 0;
  const totalHire = getValue('total_hire');
  const advance = getValue('advance');
  const hamali = getValue('hamali');
  const tds = getValue('tds');
  const stCharges = getValue('st_charges');
  const commission = getValue('commission');
  const otherCharges = getValue('other_charges');

  const balance = totalHire - advance;
  document.getElementById('balance').value = balance.toFixed(2);

  const myExpense = hamali + tds + stCharges + commission + otherCharges;
  document.getElementById('myExpense').value = myExpense.toFixed(2);

  const profit = (advance - myExpense) + balance;
  document.getElementById('profit').value = profit.toFixed(2);
}


document.addEventListener('DOMContentLoaded', () => {
  calculateFinalAmounts();
  fillPartyDetails();
  fillVehicleDetails();
});
</script>
{% include "footer.html" %}